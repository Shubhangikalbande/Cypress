import {setRunnerMode, getOffset} from '../utility.js'

/**
 * Hides the Cypress UI while running a test. However, this can only run after the spec file is loaded, 
 * so the video will have to be trimmed to cut out the part where the test is loading.
 * When run under `cypress run`, the UI will be hidden.
 * When run under `cypress open`, the UI will be visible by default, but you can change that by passing true as a parameter
 * @param {boolean} forceOnCypressOpen - Whether or not the UI will be forced to be hidden in `cypress open` mode
 * @returns {void}
 */
function hideCypress(forceOnCypressOpen = false) {
    /**
     * Disclaimer: I know the order of these actions could be improved. I have tried this myself.
     * However, any of the other, more reasonable sequences that I have tried, 
     * result in the recording freezing for a couple of seconds, some time after the website loads.
     * I don't know why, but this order works, so it will stay like this forever :>
     * Yes, the otherwise completely useless querySelector call is included in this conundrum lmao
     */

    // If in cypress run, then definitely hide the UI.
    // But in cypress open, you probably want to still view the UI.
    // By default, the function will skip hiding the UI in cypress open mode.
    if (Cypress.env('CY_VIDEO_MODE') != true) {
        return
    }

    Cypress.log({displayName: "hideCypress"})
    
    if (Cypress.config('isInteractive') && !forceOnCypressOpen) {
        setRunnerMode(false)
        return
    }

    if (Cypress.env('cypressHidden')) {
        throw 'hideCypress cannot be called more than once in a spec file. Please only call it once. This is best done in a before() context at the top level describe.'
    }

    if (Cypress.version[1] === ".") {

        Cypress.env('cypressHidden', true)

        // Configure the viewport to take full screen video values
        setRunnerMode(true)

        // Hide the side bar
        // const sidebar = window.parent.document.getElementsByClassName("reporter-wrap")[0]
        // sidebar.setAttribute("style", "visibility: hidden")

        // Snap the runner to the top left
        // And instead of hiding the side bar, just stretch the runner over the side bar and give it a high z-index
        // This way, the timer in the sidebar can still notify the video recorder to record a frame.
        const runner = window.parent.document.getElementsByClassName("runner container")[0]
        runner.setAttribute("style", "left: 0px; z-index: 100")

        // Hide the resizer between the side bar and the runner
        const runnerResizer = window.parent.document.getElementsByClassName("runner-resizer")[0]
        runnerResizer.setAttribute("style", "visibility: hidden")

        // Without this line, the recording keeps freezing for 3 seconds a bit after the website loads
        // I do not know why, but with without this line it's been consistently doing this
        // and with this line it's fine.
        // Look, I hate it too ;-;
        document.querySelector("#app > div > div.runner.container > header")

        // The recording resolution of the cypress video recorder is 1280x720
        // I cannot seem to find where that is defined, so excuse the magic numbers
        const sizeContainer = window.parent.document.getElementsByClassName("size-container")[0]
        sizeContainer.setAttribute("style", "transform: scale(1); width: " + 1280 + "px; height: " + 720 + "px")

        // This step is also necessary in properly resizing and repositioning the runner :>
        const iframesContainer = window.parent.document.getElementsByClassName("iframes-container")[0]
        iframesContainer.setAttribute("style", "top: 0px; left: 0px")

        // Hide the header above the website that contains the website url and such
        const header = runner.children[0]
        header.setAttribute("style", "visibility: hidden")
    } else {
        // Configure the viewport to take full screen video values
        setRunnerMode(true)

        // Re-position the div that contains everything right of the sidebar
        const autPanel = window.parent.document.querySelector('[data-cy="aut-panel"]')
        const mainOffset = getOffset(autPanel)
        autPanel.style.left = -mainOffset.left + "px"
        autPanel.style.top = -mainOffset.top + "px"
        autPanel.style.position = "absolute"
        autPanel.style.zIndex = 100

        // Re-position, re-scale, and re-size the runner to fit snugly on the screen :D
        const runner = window.parent.document.querySelector("#unified-runner")
        const runnerOffset = getOffset(runner)
        runner.style.transform = "scale(1, 1)"
        runner.style.top = "0px"
        runner.style.left = -runnerOffset.left + 16 + "px"  // I don't know why this needs an extra offset of 16px, but this works so eh.
        runner.style.width = "1280px"
        runner.style.height = "720px"
    }
}

Cypress.Commands.add('hideCypress', {prevSubject: false}, hideCypress)
